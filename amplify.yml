version: 1
frontend:
  phases:
    preBuild:
      commands:
        - set -euo pipefail
        # --- fetch SSM to .env ---
        - set -euo pipefail
        - >
          aws ssm get-parameters-by-path --region us-east-1 --path "/notion-sync-gcal/" --recursive --with-decryption
          --query 'Parameters[].{K:Name,V:Value}' --output text
          | awk -F'\t' '{k=$1; gsub(".*/","",k); printf("%s=%s\n", toupper(k), $2)}' > .env
        - echo "Loaded keys:" && awk -F'=' '{print $1}' .env | sort
        - export NVM_DIR="$HOME/.nvm"; [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
        # --- Node version via nvm ---
        - export NVM_DIR="$HOME/.nvm"
        - '[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"'
        - nvm install 20 # 建議用 20（Amplify 官方長期支援），22 並非所有映像都有
        - nvm use 20
        - node -v
        - npm ci
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
