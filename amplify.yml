version: 1
frontend:
  phases:
    preBuild:
      commands:
        - set -euo pipefail
        # store SSM parameters to .env
        - >
          aws ssm get-parameters-by-path --region us-east-1 --path "/notion-sync-gcal/production/" --recursive --with-decryption
          --query 'Parameters[].{K:Name,V:Value}' --output text
          | awk -F'\t' '{k=$1; gsub(".*/","",k); printf("%s=%s\n", toupper(k), $2)}' > .env

        # list keys only
        - echo "Loaded keys:" && awk -F'=' '{print $1}' .env | sort

        # list masked .env
        - echo "Masked .env preview:" && sed -E 's/^([^=]+=)(...).*$/\1\2*******/' .env | sort

        # list unmasked .env (for debugging only, remove in production)
        - echo "Unmasked .env preview:" && cat .env | sort

        # list all env vars
        - echo "All env vars:" && printenv | sort

        # Node version
        - export NVM_DIR="$HOME/.nvm"; [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
        - nvm install 20 && nvm use 20
        - node -v
        - npm ci
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
